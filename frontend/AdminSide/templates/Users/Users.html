{% extends 'AdminSide/shared/base.html' %}
{% load staticfiles %}
{% block content %}

    
    <script src={% static 'dashboard.js' %}></script>
    <!-- ============================================================== -->
    <!-- Preloader -->
    <!-- ============================================================== -->
    <div class="preloader">
        <svg class="circular" viewBox="25 25 50 50">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"/>
        </svg>
    </div>
    <!-- ============================================================== -->
    <!-- Wrapper -->
    <!-- ============================================================== -->

    <div id="wrapper">
        <!-- ============================================================== -->
        <!-- Topbar header - style you can find in pages.scss -->
        <!-- ============================================================== -->
        {% include 'AdminSide/shared/header.html' %}
        <!-- End Top Navigation -->
        <!-- ============================================================== -->
        <!-- Left Sidebar - style you can find in sidebar.scss  -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        {% include 'AdminSide/shared/side_bar.html' %}
        <!-- End Left Sidebar -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Page Content -->
        <!-- ============================================================== -->
        <div id="page-wrapper">
          <div class="container-fluid">
              <div class="row bg-title">
                  <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12">
                      <h4 class="page-title">Manage Users</h4>
                  </div>
                  <!-- /.col-lg-12 -->
              </div>
              <div class="row">
                  <div class="col-md-12">
                      <div class="white-box" style="padding-bottom:100px">
                          
                          <div class="row">
                              <div class="col-md-4">
                                  <h3 class="box-title">Users List</h3>
                              </div>
                              <div class="col-md-8">
                                  
                              </div>
                          </div>
                             
                          <div class="table-responsive">
                              <table class="table" id="royal_travels_users">
                                  
                                  <thead>
                                  <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Gender</th>
                                    <th>DOB</th>
                                    <th>Address</th>
                                    <th>Account Type</th>
                                  </tr>
                                  </thead>
                                  <tbody id="users">
                                      
                                  </tbody>
                              </table>
                          </div>
                          
                      </div>
                  </div>
              </div>
          </div>

            <!-- /.container-fluid -->
            {% include 'AdminSide/shared/footer.html' %}

        </div>
        <!-- ============================================================== -->
        <!-- End Page Content -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Wrapper -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <script src="{% static 'js/jquery.slimscroll.js' %}"></script>    
    <script src="{% static 'js/custom.min.js' %}"></script>
    <script src="{% static 'js/metisMenu.js' %}"></script>
   <script>
       var user_api_url = "http://127.0.0.1:8000/tms_api/users_api/";
       var account_type_api_url="http://127.0.0.1:8000/tms_api/accout_type_api/";
       var user_auth_api_url="http://127.0.0.1:8000/tms_api/user_auth_api/";
        $(document).ready(function () {
            function getUsersCredentials(){
                let users_credentials=[];
                $.ajax({
                    url: user_auth_api_url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        data=JSON.parse(data);
                        $.each(data, function (index, object) {
                            users_credentials.push(object);
                        });
                    },
                    error: function (data) {
                        console.log(data);
                    }
                });
                return users_credentials;
            }
            var users_credentials = getUsersCredentials();
            function getUserEmailById(UserId){
                var user_email = "";
                $.each(users_credentials, function (index, object) {
                    if(object.UserId==UserId){
                        user_email=object.Email;
                        return user_email;
                    }
                });
                return user_email;
            }
            function getAccountTypes() {
                let account_types=[];
                                $.ajax({
                    url: account_type_api_url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        $.each(data, function (index, object) {
                            account_types.push(object);
                        });
                    },
                    error: function (data) {
                        console.log(data);
                    }
                });
                return account_types;
            }
            
            var account_types = getAccountTypes();
            function getAccountTypeById(id) {
                var account_type = "";
                for(var i=0;i<account_types.length;i++){
                    if(account_types[i].AccountsTypeId==id){
                        account_type=account_types[i].AccountTypeName;
                        break;
                    }
                }
                return account_type;
            }
            getUsers();
            function getUsers() {
                $.ajax({
                url: user_api_url,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#users').empty();
                    user_account_type="";
                    $.each(data, function (index, object) {
                        $('#users').append(`<tr><td>${object.UserId}</td>
                            <td>${object.Fname + " " + object.Lname}</td>
                            <td>${getUserEmailById(object.UserId)}</td>
                            <td>${object.Gender}</td>
                            <td>${object.UserDOB}</td>
                            <td>${object.Address}</td>
                            <td>${getAccountTypeById(object.AccountTypeId)}</td>
                             <td>
                                <a  class="button btn-sm btn-danger" 
                                id="btn-${object.UserId}"
                                 style="margin-left:8px">
                                <i class="fa fa-trash-o"></i></a> 
                            </td> 
                            </tr>`);
                        document.getElementById(`btn-${object.UserId}`).addEventListener("click", () => {
                            DeleteUserByID(object.UserId); 
                        });
                    });
                }
            });
            }

            function DeleteUserByID(id) {
                
                var flag=confirm("Are you sure you want to delete this user?");
                if(flag){
                    data={
                        "id":id
                    }
                $.ajax(
                    {
                        url: user_api_url + id,
                        type: 'DELETE',
                        dataType: 'json',
                        contentType: 'application/json',
                        data: data,
                        success: function (data) {
                            alert("User deleted successfully");
                            getUsers();
                        },
                        error: function (data) {
                            alert("User not deleted");
                        }
                    }
                );
            }
            else{
                return;
            }

            }
        });


    </script>

{% endblock %}
